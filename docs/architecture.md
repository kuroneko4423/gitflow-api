# GitHub API Service - アーキテクチャ図

## 目次
1. [システム全体構成図](#システム全体構成図)
2. [コンポーネント構成図](#コンポーネント構成図)
3. [シーケンス図](#シーケンス図)
4. [データフロー図](#データフロー図)
5. [デプロイメント構成図](#デプロイメント構成図)

---

## システム全体構成図

```
┌─────────────────────────────────────────────────────────────────────┐
│                          クライアント層                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │ Browser  │  │   CLI    │  │  CI/CD   │  │ Webhook  │           │
│  │  (curl)  │  │  Tool    │  │ Pipeline │  │ Service  │           │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘           │
└───────┼─────────────┼─────────────┼─────────────┼──────────────────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                      │
              HTTP/HTTPS Request
                      │
        ┌─────────────▼─────────────┐
        │     Load Balancer         │ (オプション)
        │   (Nginx / ALB / etc.)    │
        └─────────────┬─────────────┘
                      │
        ┌─────────────▼─────────────────────────────────────────────┐
        │                  Application Layer                        │
        │  ┌──────────────────────────────────────────────────┐    │
        │  │           FastAPI Application                     │    │
        │  │  ┌────────────────────────────────────────────┐  │    │
        │  │  │         API Endpoints                      │  │    │
        │  │  │  - GET  /                                  │  │    │
        │  │  │  - POST /create-issue                      │  │    │
        │  │  │  - POST /create-pr                         │  │    │
        │  │  │  - POST /approve-merge-pr                  │  │    │
        │  │  └─────────────┬──────────────────────────────┘  │    │
        │  │                │                                  │    │
        │  │  ┌─────────────▼──────────────────────────────┐  │    │
        │  │  │      Business Logic Layer                  │  │    │
        │  │  │  - find_latest_pr()                        │  │    │
        │  │  │  - find_latest_branch()                    │  │    │
        │  │  │  - get_headers()                           │  │    │
        │  │  │  - get_owner()                             │  │    │
        │  │  └─────────────┬──────────────────────────────┘  │    │
        │  │                │                                  │    │
        │  │  ┌─────────────▼──────────────────────────────┐  │    │
        │  │  │    HTTP Client Layer (httpx)               │  │    │
        │  │  │  - AsyncClient                             │  │    │
        │  │  │  - Connection pooling                      │  │    │
        │  │  │  - Error handling                          │  │    │
        │  │  └─────────────┬──────────────────────────────┘  │    │
        │  └────────────────┼────────────────────────────────┘  │    │
        │                   │                                   │    │
        │  ┌────────────────▼────────────────────────────────┐ │    │
        │  │         Uvicorn ASGI Server                     │ │    │
        │  │  - Worker processes                             │ │    │
        │  │  - Event loop                                   │ │    │
        │  └─────────────────────────────────────────────────┘ │    │
        └────────────────────┬────────────────────────────────────┘
                             │
                     HTTPS (TLS 1.2+)
                             │
        ┌────────────────────▼────────────────────────────────────┐
        │                External Services                        │
        │  ┌──────────────────────────────────────────────────┐  │
        │  │         GitHub REST API                          │  │
        │  │         api.github.com                           │  │
        │  │  ┌────────────────────────────────────────────┐ │  │
        │  │  │  - Issues API                              │ │  │
        │  │  │  - Pull Requests API                       │ │  │
        │  │  │  - Repositories API                        │ │  │
        │  │  │  - Reviews API                             │ │  │
        │  │  └────────────────────────────────────────────┘ │  │
        │  └──────────────────────────────────────────────────┘  │
        └─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                      Configuration Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  .env File   │  │  Environment │  │   Secrets    │             │
│  │              │  │   Variables  │  │   Manager    │             │
│  │ GITHUB_TOKEN │  │              │  │   (Option)   │             │
│  │ GITHUB_OWNER │  │              │  │              │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        main.py                                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              FastAPI Application Instance                │   │
│  │              app = FastAPI(...)                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Request/Response Models                     │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  CreateIssueRequest (Pydantic BaseModel)         │   │   │
│  │  │    - repository: str                             │   │   │
│  │  │    - title: str                                  │   │   │
│  │  │    - body: str                                   │   │   │
│  │  │    - labels: Optional[List[str]]                 │   │   │
│  │  │    - assignees: Optional[List[str]]              │   │   │
│  │  │    - milestone: Optional[int]                    │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  CreatePRRequest (Pydantic BaseModel)            │   │   │
│  │  │    - repository: str                             │   │   │
│  │  │    - branch: Optional[str]                       │   │   │
│  │  │    - title: Optional[str]                        │   │   │
│  │  │    - body: Optional[str]                         │   │   │
│  │  │    - base: Optional[str]                         │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  ApproveMergePRRequest (Pydantic BaseModel)      │   │   │
│  │  │    - repository: str                             │   │   │
│  │  │    - pr_number: Optional[int]                    │   │   │
│  │  │    - review_comment: Optional[str]               │   │   │
│  │  │    - merge_method: Optional[str]                 │   │   │
│  │  │    - commit_title: Optional[str]                 │   │   │
│  │  │    - commit_message: Optional[str]               │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Helper Functions                            │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  get_headers() -> dict                           │   │   │
│  │  │    - GitHub API認証ヘッダーを生成                │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  get_owner() -> str                              │   │   │
│  │  │    - 環境変数からGitHub Ownerを取得              │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  async find_latest_open_pr(repo) -> int | None   │   │   │
│  │  │    - 最新のオープンPRを検索                      │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  async find_latest_branch(repo) -> str | None    │   │   │
│  │  │    - 最新コミットのブランチを検索                │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              API Endpoints                               │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  @app.get("/")                                   │   │   │
│  │  │  async def root()                                │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  @app.post("/create-issue")                      │   │   │
│  │  │  async def create_issue(request)                 │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  @app.post("/create-pr")                         │   │   │
│  │  │  async def create_pull_request(request)          │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │  @app.post("/approve-merge-pr")                  │   │   │
│  │  │  async def approve_and_merge_pr(request)         │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## シーケンス図

### 1. Issue作成のシーケンス

```
┌──────┐          ┌─────────┐          ┌──────────┐          ┌────────────┐
│Client│          │FastAPI  │          │ httpx    │          │GitHub API  │
└──┬───┘          └────┬────┘          └────┬─────┘          └─────┬──────┘
   │                   │                    │                      │
   │ POST /create-issue│                    │                      │
   ├──────────────────>│                    │                      │
   │                   │                    │                      │
   │                   │ 1. Validate input  │                      │
   │                   │   (Pydantic)       │                      │
   │                   │                    │                      │
   │                   │ 2. get_headers()   │                      │
   │                   │ get_owner()        │                      │
   │                   │                    │                      │
   │                   │ 3. Create Issue    │                      │
   │                   ├───────────────────>│                      │
   │                   │                    │  POST /repos/{owner}/{repo}/issues
   │                   │                    ├─────────────────────>│
   │                   │                    │                      │
   │                   │                    │  201 Created         │
   │                   │                    │<─────────────────────┤
   │                   │<───────────────────┤  {issue_data}        │
   │                   │                    │                      │
   │                   │ 4. Add Comment     │                      │
   │                   ├───────────────────>│                      │
   │                   │                    │  POST /repos/{owner}/{repo}/issues/{number}/comments
   │                   │                    ├─────────────────────>│
   │                   │                    │  body: "@claude 実装して"
   │                   │                    │                      │
   │                   │                    │  201 Created         │
   │                   │                    │<─────────────────────┤
   │                   │<───────────────────┤  {comment_data}      │
   │                   │                    │                      │
   │                   │ 5. Build response  │                      │
   │                   │                    │                      │
   │  201 Created      │                    │                      │
   │<──────────────────┤                    │                      │
   │  {success, data}  │                    │                      │
   │                   │                    │                      │
```

### 2. PR作成のシーケンス（ブランチ自動選択）

```
┌──────┐          ┌─────────┐          ┌──────────┐          ┌────────────┐
│Client│          │FastAPI  │          │ httpx    │          │GitHub API  │
└──┬───┘          └────┬────┘          └────┬─────┘          └─────┬──────┘
   │                   │                    │                      │
   │ POST /create-pr   │                    │                      │
   │ (no branch)       │                    │                      │
   ├──────────────────>│                    │                      │
   │                   │                    │                      │
   │                   │ 1. Validate input  │                      │
   │                   │                    │                      │
   │                   │ 2. find_latest_branch()                   │
   │                   ├───────────────────>│                      │
   │                   │                    │  GET /repos/{owner}/{repo}/branches
   │                   │                    ├─────────────────────>│
   │                   │                    │                      │
   │                   │                    │  200 OK              │
   │                   │                    │<─────────────────────┤
   │                   │                    │  [{branch1}, ...]    │
   │                   │                    │                      │
   │                   │                    │  For each branch:    │
   │                   │                    │  GET /repos/{owner}/{repo}/commits/{sha}
   │                   │                    ├─────────────────────>│
   │                   │                    │                      │
   │                   │                    │  200 OK              │
   │                   │                    │<─────────────────────┤
   │                   │                    │  {commit_data}       │
   │                   │<───────────────────┤                      │
   │                   │  latest_branch     │                      │
   │                   │                    │                      │
   │                   │ 3. Create PR       │                      │
   │                   ├───────────────────>│                      │
   │                   │                    │  POST /repos/{owner}/{repo}/pulls
   │                   │                    ├─────────────────────>│
   │                   │                    │  {head, base, title, body}
   │                   │                    │                      │
   │                   │                    │  201 Created         │
   │                   │                    │<─────────────────────┤
   │                   │<───────────────────┤  {pr_data}           │
   │                   │                    │                      │
   │  200 OK           │                    │                      │
   │<──────────────────┤                    │                      │
   │  {success, data}  │                    │                      │
   │                   │                    │                      │
```

### 3. PR承認&マージのシーケンス

```
┌──────┐          ┌─────────┐          ┌──────────┐          ┌────────────┐
│Client│          │FastAPI  │          │ httpx    │          │GitHub API  │
└──┬───┘          └────┬────┘          └────┬─────┘          └─────┬──────┘
   │                   │                    │                      │
   │ POST /approve-merge-pr                 │                      │
   ├──────────────────>│                    │                      │
   │                   │                    │                      │
   │                   │ 1. Validate input  │                      │
   │                   │                    │                      │
   │                   │ 2. find_latest_open_pr() (if needed)      │
   │                   ├───────────────────>│                      │
   │                   │                    │  GET /repos/{owner}/{repo}/pulls?state=open
   │                   │                    ├─────────────────────>│
   │                   │                    │                      │
   │                   │                    │  200 OK              │
   │                   │                    │<─────────────────────┤
   │                   │<───────────────────┤  [{pr1}, ...]        │
   │                   │  pr_number         │                      │
   │                   │                    │                      │
   │                   │ 3. Approve PR      │                      │
   │                   ├───────────────────>│                      │
   │                   │                    │  POST /repos/{owner}/{repo}/pulls/{number}/reviews
   │                   │                    ├─────────────────────>│
   │                   │                    │  {event: "APPROVE", body: "LGTM"}
   │                   │                    │                      │
   │                   │                    │  200 OK              │
   │                   │                    │<─────────────────────┤
   │                   │<───────────────────┤  {review_data}       │
   │                   │                    │                      │
   │                   │ 4. Merge PR        │                      │
   │                   ├───────────────────>│                      │
   │                   │                    │  PUT /repos/{owner}/{repo}/pulls/{number}/merge
   │                   │                    ├─────────────────────>│
   │                   │                    │  {merge_method, commit_title, commit_message}
   │                   │                    │                      │
   │                   │                    │  200 OK              │
   │                   │                    │<─────────────────────┤
   │                   │<───────────────────┤  {merge_data}        │
   │                   │                    │                      │
   │  200 OK           │                    │                      │
   │<──────────────────┤                    │                      │
   │  {success, data}  │                    │                      │
   │                   │                    │                      │
```

---

## データフロー図

### リクエストからレスポンスまでのデータフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                         1. Input Phase                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                    HTTP Request (JSON)
                    {repository, title, body, ...}
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    2. Validation Phase                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Pydantic BaseModel                                      │  │
│  │  - Type checking                                         │  │
│  │  - Required field validation                             │  │
│  │  - Default value assignment                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                    Validated Python Object
                    CreateIssueRequest / CreatePRRequest / etc.
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    3. Processing Phase                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Environment Variables                                   │  │
│  │  GITHUB_TOKEN → Authorization Header                     │  │
│  │  GITHUB_OWNER → API URL construction                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Auto-detection Logic (if needed)                        │  │
│  │  - find_latest_branch()                                  │  │
│  │  - find_latest_open_pr()                                 │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                    GitHub API Request Data
                    {headers, url, payload}
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    4. External API Phase                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  httpx.AsyncClient                                       │  │
│  │  - HTTP request construction                             │  │
│  │  - Connection pooling                                    │  │
│  │  - Response handling                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                    GitHub API Response (JSON)
                    {id, number, url, state, ...}
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    5. Transformation Phase                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Response Data Mapping                                   │  │
│  │  - Extract relevant fields                               │  │
│  │  - Structure response                                    │  │
│  │  - Add metadata (success, message)                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                    Structured Response
                    {success, message, data}
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    6. Output Phase                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  FastAPI Response                                        │  │
│  │  - JSON serialization                                    │  │
│  │  - HTTP status code                                      │  │
│  │  - Content-Type header                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                    HTTP Response (JSON)
                                │
                                ▼
                             Client
```

---

## デプロイメント構成図

### パターン1: シンプル構成（開発環境）

```
┌─────────────────────────────────┐
│      Developer Machine          │
│  ┌───────────────────────────┐  │
│  │  Uvicorn                  │  │
│  │  --reload                 │  │
│  │  Port: 8000               │  │
│  │                           │  │
│  │  ┌────────────────────┐   │  │
│  │  │  FastAPI App       │   │  │
│  │  │  (main.py)         │   │  │
│  │  └────────────────────┘   │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │  .env                     │  │
│  │  GITHUB_TOKEN=xxx         │  │
│  │  GITHUB_OWNER=yyy         │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
         │
         │ http://localhost:8000
         ▼
    ┌─────────┐
    │ Browser │
    └─────────┘
```

### パターン2: 本番環境（単一サーバー）

```
┌───────────────────────────────────────────────────────────┐
│                    Production Server                      │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  Nginx (Reverse Proxy)                              │ │
│  │  - SSL/TLS termination                              │ │
│  │  - Rate limiting                                    │ │
│  │  - Load balancing                                   │ │
│  │  Port: 443 (HTTPS)                                  │ │
│  └────────────────┬────────────────────────────────────┘ │
│                   │                                      │
│                   │ Proxy pass                           │
│                   ▼                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  Uvicorn (Multiple Workers)                         │ │
│  │  --workers 4                                        │ │
│  │  --host 127.0.0.1                                   │ │
│  │  --port 8000                                        │ │
│  │                                                     │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐           │ │
│  │  │ Worker 1 │ │ Worker 2 │ │ Worker 3 │ ...       │ │
│  │  └──────────┘ └──────────┘ └──────────┘           │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐  │ │
│  │  │  FastAPI Application                         │  │ │
│  │  └──────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  systemd / supervisor                               │ │
│  │  - Auto restart                                     │ │
│  │  - Logging                                          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  Environment Variables                              │ │
│  │  /etc/environment or .env                           │ │
│  └─────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────┘
         │
         │ HTTPS
         ▼
    ┌─────────┐
    │  Client │
    └─────────┘
```

### パターン3: Docker構成

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker Host                            │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  Docker Container: github-api-service                 │ │
│  │                                                       │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │  Python 3.11                                    │ │ │
│  │  │                                                 │ │ │
│  │  │  ┌───────────────────────────────────────────┐ │ │ │
│  │  │  │  Uvicorn                                  │ │ │ │
│  │  │  │  Port: 8000 (internal)                    │ │ │ │
│  │  │  │                                           │ │ │ │
│  │  │  │  ┌─────────────────────────────────────┐ │ │ │ │
│  │  │  │  │  FastAPI Application                │ │ │ │ │
│  │  │  │  │  (main.py)                          │ │ │ │ │
│  │  │  │  └─────────────────────────────────────┘ │ │ │ │
│  │  │  └───────────────────────────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                       │ │
│  │  Environment Variables (--env-file .env)              │ │
│  │  Volume Mount (optional for logs)                     │ │
│  │                                                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  Port Mapping: 8000:8000                                   │
└─────────────────────────────────────────────────────────────┘
         │
         │ HTTP
         ▼
    ┌─────────┐
    │  Client │
    └─────────┘
```

### パターン4: クラウド構成（AWS例）

```
                        Internet
                           │
                           ▼
┌──────────────────────────────────────────────────────────────┐
│  AWS Route 53                                                │
│  DNS Management                                              │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│  AWS Certificate Manager                                     │
│  SSL/TLS Certificate                                         │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│  Application Load Balancer (ALB)                             │
│  - HTTPS (443)                                               │
│  - Health checks                                             │
│  - Target groups                                             │
└────────────────────────┬─────────────────────────────────────┘
                         │
         ┌───────────────┴────────────────┐
         │                                │
         ▼                                ▼
┌──────────────────────┐       ┌──────────────────────┐
│  EC2 Instance 1      │       │  EC2 Instance 2      │
│  (Auto Scaling)      │       │  (Auto Scaling)      │
│                      │       │                      │
│  ┌────────────────┐  │       │  ┌────────────────┐  │
│  │ Uvicorn        │  │       │  │ Uvicorn        │  │
│  │ --workers 4    │  │       │  │ --workers 4    │  │
│  │                │  │       │  │                │  │
│  │ ┌────────────┐ │  │       │  │ ┌────────────┐ │  │
│  │ │ FastAPI    │ │  │       │  │ │ FastAPI    │ │  │
│  │ │ App        │ │  │       │  │ │ App        │ │  │
│  │ └────────────┘ │  │       │  │ └────────────┘ │  │
│  └────────────────┘  │       │  └────────────────┘  │
│                      │       │                      │
│  Environment:        │       │  Environment:        │
│  From Secrets Mgr    │       │  From Secrets Mgr    │
└──────────────────────┘       └──────────────────────┘
         │                                │
         └────────────────┬───────────────┘
                          │
                          ▼
┌──────────────────────────────────────────────────────────────┐
│  AWS Secrets Manager                                         │
│  - GITHUB_TOKEN                                              │
│  - GITHUB_OWNER                                              │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  CloudWatch                                                  │
│  - Logs                                                      │
│  - Metrics                                                   │
│  - Alarms                                                    │
└──────────────────────────────────────────────────────────────┘
```

### パターン5: Kubernetes構成

```
┌───────────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                         │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Ingress Controller (nginx-ingress)                     │ │
│  │  - SSL/TLS termination                                  │ │
│  │  - Routing rules                                        │ │
│  └────────────────────┬────────────────────────────────────┘ │
│                       │                                      │
│                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  Service (github-api-service)                           │ │
│  │  Type: ClusterIP                                        │ │
│  │  Port: 8000                                             │ │
│  └────────────────────┬────────────────────────────────────┘ │
│                       │                                      │
│         ┌─────────────┼─────────────┐                        │
│         │             │             │                        │
│         ▼             ▼             ▼                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │  Pod 1   │  │  Pod 2   │  │  Pod 3   │                   │
│  │          │  │          │  │          │                   │
│  │  ┌─────┐ │  │  ┌─────┐ │  │  ┌─────┐ │                   │
│  │  │ App │ │  │  │ App │ │  │  │ App │ │                   │
│  │  └─────┘ │  │  └─────┘ │  │  └─────┘ │                   │
│  └──────────┘  └──────────┘  └──────────┘                   │
│                                                               │
│  Managed by Deployment (replicas: 3)                         │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  ConfigMap / Secret                                     │ │
│  │  - GITHUB_TOKEN (from Secret)                           │ │
│  │  - GITHUB_OWNER (from ConfigMap)                        │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  HorizontalPodAutoscaler                                │ │
│  │  Min: 2, Max: 10                                        │ │
│  │  CPU: 70%                                               │ │
│  └─────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
```

---

## 補足情報

### 使用ポート

| ポート | 用途 | プロトコル |
|-------|------|-----------|
| 8000 | FastAPI Application（デフォルト） | HTTP |
| 443 | HTTPS（本番環境） | HTTPS |
| 80 | HTTPリダイレクト（本番環境） | HTTP |

### 環境変数の配置

| 環境 | 配置場所 |
|------|---------|
| 開発 | `.env`ファイル |
| Docker | `--env-file`または環境変数 |
| AWS | Secrets Manager / Parameter Store |
| Kubernetes | Secret / ConfigMap |

### スケーリング戦略

- **垂直スケーリング**: サーバーのCPU/メモリを増強
- **水平スケーリング**: Uvicorn workerを増やす、サーバー台数を増やす
- **自動スケーリング**: K8s HPA、AWS Auto Scaling

### 監視とログ

- **アクセスログ**: Uvicorn標準出力
- **アプリケーションログ**: Python logging
- **メトリクス**: Prometheus + Grafana（推奨）
- **エラートラッキング**: Sentry（推奨）
